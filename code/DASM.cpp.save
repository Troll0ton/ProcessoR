#include "../include/DASM.h"

//-----------------------------------------------------------------------------

int disassembling ()
{
    Disassember Dasm = { 0 };

    if(disassember_ctor (&Dasm) == ERR_CTOR)
    {
        return ERR_DASM;
    }

    read_files (&Dasm);

    file_out_ctor (&Dasm);

    disassember_dtor (&Dasm);

    return 0;
}

//-----------------------------------------------------------------------------

void file_out_ctor (Disassember &Dasm)
{
    for(int ip = 1; ip <= (int) Cpu->code[0]; ip++)
    {
        int cmd_d = Cpu->code[ip];
        double arg_d = 0;
        int pos = 0;

        if(cmd_d & MASK_REG)
        {
            arg_d += Cpu->regs[(int) Cpu->code[ip + 1]];
            pos++;
        }

        if(cmd_d & MASK_IMM)
        {
            arg_d += Cpu->code[ip + 1 + pos];
        }

        if(cmd_d & MASK_RAM)
        {
            arg_d = Cpu->ram[(int) arg_d];
        }

        if(cmd_d & MASK_RAM &&
           cmd_d & MASK_IMM &&
           cmd_d & MASK_REG   ) pos = 1;

        else pos = 0;

        handle_cmds (cmd_d & MASK_CMD, arg_d, &ip, Cpu);
        ip += pos;
    }
}

//-----------------------------------------------------------------------------

void handle_cmds (int cmd_d, double arg_d, int *ipp, Processor *Cpu)
{
    int ip = *ipp;

    double f1 = -1;
    double f2 = -1;

    #define CMD_DEF(cmd, code, ...) \
        case cmd:                   \
            code                    \
            __VA_ARGS__             \
            break;

    switch (cmd_d)
    {
        #include "../include/codegen.h"

        default:
            printf ("?%d \n", cmd_d);
            break;
    }

    #undef CMD_DEF

    stack_dumps (&Cpu->Stk, Cpu->Info.log_file);

    *ipp = ip;
}

//-----------------------------------------------------------------------------

int main ()
{
    disassembling ();

    return 0;
}

//-----------------------------------------------------------------------------

